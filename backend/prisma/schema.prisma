// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String      @id @default(cuid())
  address       String      @unique
  walletAddress String      @unique // Alias for address for backward compatibility
  ensName       String?
  email         String?  
  name          String?
  avatar        String?
  role          Role        @default(USER)
  status        UserStatus  @default(ACTIVE)
  isVerified    Boolean     @default(false)
  lastActiveAt  DateTime    @default(now())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Profile & Identity
  profile       UserProfile?
  
  // Credit & Scoring
  creditScores      CreditScore[]
  loanApplications  LoanApplication[]
  loanContracts     LoanContract[]
  
  // Social & Verification
  socialProfiles    SocialProfile[]
  verifications     UserVerification[]
  
  // Activity & Analytics
  walletAnalytics   WalletAnalytics[]
  transactionLogs   TransactionLog[]

  @@map("users")
}

enum Role {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

model UserProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  bio           String?
  website       String?
  location      String?
  occupation    String?
  experienceLevel String? // beginner, intermediate, advanced, expert
  riskTolerance String?  // conservative, moderate, aggressive
  
  // Privacy Settings
  isPublic      Boolean  @default(false)
  showBalances  Boolean  @default(false)
  showHistory   Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("user_profiles")
}

model CreditScore {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  score         Int      // 0-1000 credit score
  riskLevel     RiskLevel
  confidence    Float    // AI model confidence 0-1
  
  // Category Scores
  transactionHistory    Int
  defiUsage            Int
  lendingRecord        Int
  walletAge            Int
  assetHoldings        Int
  riskDetection        Int
  socialReputation     Int
  activityLevel        Int
  
  // Metadata
  dataPoints    Json     // Raw data used for scoring
  modelVersion  String   
  calculatedAt  DateTime @default(now())
  expiresAt     DateTime
  
  // Blockchain Data
  chainId       Int
  blockNumber   BigInt
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("credit_scores")
  @@index([userId, calculatedAt])
  @@index([score])
  @@index([riskLevel])
}

model LoanApplication {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  requestedAmount BigInt   // Amount in wei
  purpose         String
  termMonths      Int
  collateralType  String?
  collateralAmount BigInt?
  
  status          ApplicationStatus @default(PENDING)
  creditScoreId   String?
  
  // AI Decision
  aiDecision      Json?    // AI model decision reasoning
  riskAssessment  Json?    // Risk factors and analysis
  recommendedRate Float?   // Suggested interest rate
  maxApprovalAmount BigInt? // AI recommended max amount
  
  // Review Process
  reviewedBy      String?
  reviewNotes     String?
  reviewedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  contract        LoanContract?

  @@map("loan_applications")
  @@index([userId, status])
  @@index([status, createdAt])
}

model LoanContract {
  id                String   @id @default(cuid())
  applicationId     String   @unique
  application       LoanApplication @relation(fields: [applicationId], references: [id])
  
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  
  // Contract Terms
  principalAmount   BigInt
  interestRate      Float
  termMonths        Int
  startDate         DateTime
  endDate           DateTime
  
  // Payment Schedule
  monthlyPayment    BigInt
  totalPayments     Int
  paidPayments      Int     @default(0)
  
  // Status
  status            ContractStatus @default(ACTIVE)
  
  // Blockchain
  contractAddress   String?
  txHash           String?
  chainId          Int?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  payments         LoanPayment[]

  @@map("loan_contracts")
  @@index([userId, status])
  @@index([status])
}

model LoanPayment {
  id            String   @id @default(cuid())
  contractId    String
  contract      LoanContract @relation(fields: [contractId], references: [id])
  
  amount        BigInt
  dueDate       DateTime
  paidDate      DateTime?
  status        PaymentStatus @default(PENDING)
  
  // Blockchain
  txHash        String?
  blockNumber   BigInt?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("loan_payments")
  @@index([contractId, status])
  @@index([dueDate])
}

model SocialProfile {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  platform  SocialPlatform
  username  String
  profileUrl String?
  isVerified Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("social_profiles")
  @@unique([userId, platform])
}

model UserVerification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        VerificationType
  provider    String   // gitcoin, worldcoin, ens, etc.
  externalId  String?
  metadata    Json?
  score       Float?   // Verification score/confidence
  isActive    Boolean  @default(true)
  
  verifiedAt  DateTime @default(now())
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("user_verifications")
  @@index([userId, type])
  @@index([type, isActive])
}

model WalletAnalytics {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  address         String
  chainId         Int
  
  // Balance Analytics
  totalValue      BigInt   // Total portfolio value in wei
  tokenCount      Int      // Number of different tokens
  nftCount        Int      // Number of NFTs
  
  // Activity Analytics
  transactionCount BigInt
  firstTxDate     DateTime?
  lastTxDate      DateTime?
  avgTxValue      BigInt?
  
  // DeFi Analytics
  defiProtocols   String[] // List of protocols interacted with
  liquidityPools  Json?    // LP positions
  stakingPositions Json?   // Staking positions
  
  // Risk Analytics
  riskScore       Float?   // 0-1 risk score
  anomalyFlags    String[] // Detected anomalies
  
  calculatedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("wallet_analytics")
  @@index([userId, chainId])
  @@index([address])
}

model TransactionLog {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  // Transaction Data
  hash        String   @unique
  from        String
  to          String?
  value       BigInt
  gasUsed     BigInt?
  gasPrice    BigInt?
  
  // Block Data
  blockNumber BigInt
  blockHash   String?
  timestamp   DateTime
  
  // Chain Data
  chainId     Int
  
  // Classification
  type        TxType?  // defi, nft, transfer, contract
  category    String?  // swap, stake, lend, etc.
  protocol    String?  // uniswap, aave, compound, etc.
  
  // Analysis
  riskScore   Float?   // Transaction risk score
  anomalyScore Float?  // Anomaly detection score
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("transaction_logs")
  @@index([userId, timestamp])
  @@index([from])
  @@index([blockNumber])
  @@index([chainId, timestamp])
}

model ApiKey {
  id          String   @id @default(cuid())
  name        String
  key         String   @unique
  userId      String?
  
  // Permissions
  permissions String[] // read, write, admin
  rateLimit   Int      @default(100)
  
  // Status
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  
  // Expiration
  expiresAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("api_keys")
  @@index([key])
  @@index([userId])
}

// Enums
enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  EXPIRED
}

enum ContractStatus {
  ACTIVE
  COMPLETED
  DEFAULTED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  FAILED
}

enum SocialPlatform {
  TWITTER
  DISCORD
  GITHUB
  LINKEDIN
  TELEGRAM
}

enum VerificationType {
  GITCOIN_PASSPORT
  WORLDCOIN
  ENS
  EMAIL
  PHONE
  KYC
}

enum TxType {
  TRANSFER
  DEFI
  NFT
  CONTRACT_INTERACTION
  STAKING
  GOVERNANCE
}